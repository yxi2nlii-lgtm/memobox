<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MEMOCARD - AUTO DEMO</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <style>
        /* --- 弹窗与基础样式 --- */
        #confirm-layer { position: fixed; inset: 0; z-index: 20000; background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); display: none; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; }
        .confirm-card { width: 85%; max-width: 320px; background: rgba(255,255,255,0.08); padding: 30px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .confirm-card h2 { font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #fff; }
        .confirm-card p { font-size: 12px; color: rgba(255,255,255,0.5); line-height: 1.6; margin-bottom: 25px; }
        .confirm-btns { display: flex; gap: 12px; }
        .c-btn { flex: 1; padding: 15px; border-radius: 15px; border: none; font-weight: 700; font-family: inherit; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .c-btn.cancel { background: rgba(255,255,255,0.1); color: white; }
        .c-btn.confirm { background: #ffffff; color: #000; }
        .c-btn.danger { background: #ff3b30; color: white; }
        
        #setup-layer { position: fixed; inset: 0; z-index: 10000; background: #1a1a1a; display: flex; align-items: center; justify-content: center; transition: opacity 0.8s ease, transform 0.8s ease; }
        .setup-card { width: 85%; max-width: 400px; color: white; text-align: left; background: rgba(255,255,255,0.05); padding: 30px; border-radius: 30px; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .setup-card h2 { font-size: 22px; margin-bottom: 20px; font-weight: 600; font-family: 'Poppins'; }
        .input-box { margin-bottom: 20px; }
        .input-box label { display: block; font-size: 12px; opacity: 0.6; margin-bottom: 8px; text-transform: uppercase; }
        .input-box input, .input-box textarea { width: 100%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 12px; color: white; font-family: inherit; outline: none; }
        .generate-btn { width: 100%; padding: 16px; border-radius: 15px; border: none; background: #ffffff; color: #000; font-weight: 600; cursor: pointer; font-size: 18px; letter-spacing: 1px; }

        body.ready #setup-layer { opacity: 0; pointer-events: none; transform: translateY(-20px); }
        #reset-trigger { position: fixed; top: 20px; right: 20px; z-index: 5000; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; font-size: 10px; cursor: pointer; opacity: 0.3; }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }
        body { background: #1a1a1a; font-family: 'Poppins', sans-serif; overflow: hidden; height: 100vh; width: 100vw; touch-action: none; }
        
        .center-hub { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 4000; pointer-events: none; }
        .main-avatar { width: 76px; height: 76px; border-radius: 50%; background: rgba(255,255,255,0.1); overflow: hidden; transition: all 1s cubic-bezier(0.19, 1, 0.22, 1); cursor: pointer; pointer-events: auto; z-index: 4001; flex-shrink: 0; border: 2px solid rgba(255,255,255,0.2); }
        body.state-hero .main-avatar { width: 280px; height: 280px; box-shadow: 0 30px 80px rgba(0,0,0,0.6); transform: translateY(-60px); }
        
        .hero-text-block { position: absolute; top: 50%; left: 0; width: 100%; padding-top: 100px; text-align: center; color: white; transition: all 0.7s ease; pointer-events: none; opacity: 0; transform: translateY(20px); }
        body.state-hero .hero-text-block { opacity: 1; transform: translateY(0); }
        .hero-text-block h1 { font-size: 26px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; line-height: 1; margin-bottom: 10px; }
        .hero-text-block .time { font-size: 13px; opacity: 0.5; letter-spacing: 1px; margin-bottom: 25px; }
        .hero-text-block .description { font-size: 14px; font-weight: 300; line-height: 1.6; max-width: 400px; margin: 0 auto; opacity: 0.8; }
        
        .bg-glass { position: fixed; inset: 0; z-index: -1; background: #222; background-position: center; background-size: cover; transform: scale(1.8); filter: blur(60px) brightness(0.4); }
        #lineCanvas { position: fixed; inset: 0; z-index: 50; pointer-events: none; }
        #stage { position: absolute; inset: 0; z-index: 2500; pointer-events: none; }
        
        .bubble { position: absolute; border-radius: 50%; width: 120px; height: 120px; background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); cursor: grab; pointer-events: auto; opacity: 0; display: flex; align-items: center; justify-content: center; will-change: transform, opacity; z-index: 3000; }
        .bubble.spawned { opacity: 1; transition: opacity 1s ease-out; }
        .bubble.is-text { padding: 18px; font-size: 10px; color: #fff; text-align: center; line-height: 1.4; }
        .bubble.is-status { background: #fff !important; color: #000 !important; font-weight: 700; text-transform: uppercase; font-size: 10px; }
        .unread-dot { position: absolute; top: 15px; right: 15px; width: 8px; height: 8px; background: #ff3b30; border-radius: 50%; }

        /* Modal */
        #modal-overlay { position: fixed; inset: 0; z-index: 6000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); background: rgba(0,0,0,0.3); opacity: 0; transition: 0.4s; }
        #modal-overlay.active { display: flex; opacity: 1; }
        .modal-card { background: white; padding: 30px; border-radius: 30px; width: 85%; max-width: 320px; text-align: center; position: relative; }
        .modal-actions { display: flex; justify-content: center; gap: 40px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 20px; }
        .btn-icon { background: none; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; outline: none; }
        .btn-icon svg { stroke: #999; fill: none; transition: 0.3s; }
        .btn-icon.liked svg { stroke: #ff3b30; fill: #ff3b30; }
        #comment-area { display: none; margin-top: 15px; }
        .input-group { display: flex; background: #f5f5f7; border-radius: 12px; padding: 8px 12px; align-items: center; }
        .input-group input { flex: 1; background: none; border: none; outline: none; font-size: 13px; font-family: inherit; }
    </style>
</head>
<body class="state-hero">

    <div id="setup-layer">
        <div class="setup-card">
            <h2>Something Important to You...</h2>
            <div class="input-box"><label>Image</label><input type="file" id="upload-img" accept="image/*"></div>
            <div class="input-box"><label>Name</label><input type="text" id="input-name" placeholder="e.g. my lucky bamboo"></div>
            <div class="input-box"><label>Description</label><textarea id="input-desc" rows="3" placeholder="Tell the story..."></textarea></div>
            <button class="generate-btn" onclick="applyCustomization()">Save</button>
        </div>
    </div>

    <button id="reset-trigger" onclick="handleHardReset()">RESET ALL</button>
    <div class="bg-glass"></div>
    <canvas id="lineCanvas"></canvas>

    <div id="modal-overlay" onclick="closeModal()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div id="m-visual"></div>
            <p id="m-text" style="color: #333; font-size: 14px; line-height: 1.5; margin-bottom: 10px;"></p>
            <div id="comment-list"></div>
            <div class="modal-actions">
                <button class="btn-icon" id="btn-like" onclick="toggleLike()"><svg width="22" height="22" viewBox="0 0 24 24" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78l1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></button>
                <button class="btn-icon" onclick="toggleCommentBox()"><svg width="22" height="22" viewBox="0 0 24 24" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></button>
            </div>
            <div id="comment-area"><div class="input-group"><input type="text" id="comment-input" placeholder="Comment..."><button onclick="postComment()" style="border:none; background:none; color:#007AFF; font-weight:600; margin-left:10px;">Post</button></div></div>
        </div>
    </div>

    <div class="center-hub">
        <div class="main-avatar" onclick="document.body.classList.toggle('state-hero')"><img id="display-avatar" src=""></div>
        <div class="hero-text-block">
            <h1 id="display-name">LOADING...</h1>
            <p class="time" id="display-date"></p>
            <p class="description" id="display-desc"></p>
        </div>
    </div>

    <div id="stage"></div>

    <div id="confirm-layer">
        <div class="confirm-card">
            <h2 id="confirm-title">Title</h2>
            <p id="confirm-msg">Message...</p>
            <div class="confirm-btns">
                <button class="c-btn cancel" onclick="hideConfirm()">Cancel</button>
                <button class="c-btn confirm" id="confirm-action-btn">Confirm</button>
            </div>
        </div>
    </div>

<script>
    // --- 1. Firebase Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyC7OLP-hG6ekdLQewLrB9BFGQCuzRlbnTE",
        authDomain: "memo-6a74a.firebaseapp.com",
        projectId: "memo-6a74a",
        storageBucket: "memo-6a74a.firebasestorage.app",
        messagingSenderId: "487014379920",
        appId: "1:487014379920:web:aa34c9662846c0a3d60315",
        databaseURL: "https://memo-6a74a-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const configRef = db.ref('object_config');

    // --- 2. Auto Demo Data ---
    const customContentSequence = [
        { type: 'text', content: "It’s all settled in on my desk and looking very vibrant. (它已经安顿好了，放在我书桌旁，很有精神。)" },
        { type: 'text', content: "A tiny new sprout just appeared; looks like it’s happy here. (冒出了一个小尖尖，看样子它挺适应这里的。)" },
        { type: 'text', content: "Fresh water and a little trim today. Looking much cleaner now. (今天给它换了清水，修剪了黄叶，干净多了。)" },
        { type: 'text', content: "Caught some nice afternoon sun on the leaves, thought I’d share. (午后的阳光刚好照在叶子上，顺手拍一张送给你。)" },
        { type: 'text', content: "Moved it to a warmer spot now that it's getting cold. Hope you’re doing well. (降温了，把它搬到了暖和的地方，祝你一切都好。)" }
    ];
    let sequenceIndex = 0;

    // --- 3. Physics & Core ---
    const stage = document.getElementById('stage');
    const canvas = document.getElementById('lineCanvas');
    const ctx = canvas.getContext('2d');
    let bubbles = [];
    let draggedBubble = null;

    function resizeCanvas() {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr;
        canvas.height = window.innerHeight * dpr;
        ctx.scale(dpr, dpr);
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
    }

    // --- 4. Logic: Start Sequence (The Auto Part) ---
    function startSequence() {
        // 第一步：立即出现白色状态泡泡
        createBubbleElement({ type: 'text', content: "Someone picked up this memory..." }, true);

        // 第二步：每隔30秒自动出现一个新内容气泡
        const autoInterval = setInterval(() => {
            if (sequenceIndex < customContentSequence.length) {
                createBubbleElement(customContentSequence[sequenceIndex], false);
                sequenceIndex++;
            } else {
                clearInterval(autoInterval); // 全部播完后停止
            }
        }, 30000); 
    }

    function createBubbleElement(data, isStatus) {
        const el = document.createElement('div');
        el.className = `bubble is-${data.type} ${isStatus ? 'is-status' : ''}`;
        el.innerHTML = isStatus ? data.content : `<div class="unread-dot"></div>${data.content}`;
        stage.appendChild(el);
        
        bubbles.push(setupBubbleObject(el, data, isStatus));
        requestAnimationFrame(() => el.classList.add('spawned'));
        
        // 自动切到非Hero状态，方便观察
        document.body.classList.remove('state-hero');
    }

    function applyCustomization() {
        const fileInput = document.getElementById('upload-img');
        const name = document.getElementById('input-name').value;
        const desc = document.getElementById('input-desc').value;
        if (!fileInput.files[0] || !name) { alert("Please select an image and name."); return; }

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvasImg = document.createElement('canvas');
                const MAX_W = 600;
                let w = img.width, h = img.height;
                if (w > MAX_W) { h *= MAX_W / w; w = MAX_W; }
                canvasImg.width = w; canvasImg.height = h;
                canvasImg.getContext('2d').drawImage(img, 0, 0, w, h);
                const base64 = canvasImg.toDataURL('image/jpeg', 0.6);

                configRef.set({
                    imgData: base64,
                    name: name,
                    desc: desc || "A shared object.",
                    dateStr: new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).toUpperCase()
                }).then(() => {
                    // 云端存好后，启动本地 Auto Demo
                    startSequence();
                });
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(fileInput.files[0]);
    }

    // --- 5. Supporting Physics & Interaction (Unchanged) ---
    function setupBubbleObject(el, data, isStatus) {
        const ww = window.innerWidth, wh = window.innerHeight;
        const bObj = { 
            el, x: ww/2 + (Math.random()-0.5)*150 - 60, 
            y: wh/2 + (Math.random()-0.5)*150 - 60, 
            vx: 0, vy: 0, isDragged: false, data, isStatus 
        };
        let startX, startY, startTime;

        const startAction = (e) => { 
            const touch = e.touches ? e.touches[0] : e; 
            startX = touch.clientX; startY = touch.clientY; startTime = Date.now();
            draggedBubble = bObj; bObj.isDragged = true;
        };

        const endAction = (e) => { 
            if(!bObj.isDragged) return; 
            const touch = e.changedTouches ? e.changedTouches[0] : e; 
            const dist = Math.hypot(touch.clientX - startX, touch.clientY - startY); 
            if (dist < 20 && (Date.now() - startTime) < 300) {
                const dot = el.querySelector('.unread-dot'); 
                if(dot) dot.style.display = 'none'; 
                openModal(bObj);
            }
            bObj.isDragged = false; draggedBubble = null; 
        };

        el.addEventListener('mousedown', startAction);
        el.addEventListener('touchstart', startAction, {passive: false});
        window.addEventListener('mouseup', endAction);
        window.addEventListener('touchend', endAction);
        return bObj;
    }

    function animate(time) {
        const dpr = window.devicePixelRatio || 1;
        ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);
        const ww = window.innerWidth, wh = window.innerHeight;
        const avatarEl = document.querySelector('.main-avatar');
        let cx = ww / 2, cy = wh / 2;
        if (avatarEl) { const r = avatarEl.getBoundingClientRect(); cx = r.left + r.width/2; cy = r.top + r.height/2; }

        ctx.beginPath();
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
        ctx.lineWidth = 1.2;

        bubbles.forEach((b, i) => {
            const currX = b.x + 60, currY = b.y + 60;
            let prevX = cx, prevY = cy;
            if (i > 0) { prevX = bubbles[i-1].x + 60; prevY = bubbles[i-1].y + 60; }
            ctx.moveTo(prevX, prevY);
            ctx.quadraticCurveTo((prevX+currX)/2, (prevY+currY)/2 + Math.sin(time*0.002+i)*10, currX, currY);

            if (!b.isDragged) {
                const cdx = currX - cx, cdy = currY - cy, cdist = Math.sqrt(cdx*cdx + cdy*cdy) || 1;
                b.vx += (-cdy/cdist) * 0.0007; 
                b.vx += (cx - currX) * 0.00003;
                bubbles.forEach((b2, j) => {
                    if(i === j) return;
                    const pdx = (b2.x+60) - currX, pdy = (b2.y+60) - currY, pdist = Math.hypot(pdx, pdy) || 1;
                    if(pdist < 130) { const p = (130 - pdist) * 0.02; b.vx -= (pdx/pdist)*p; b.vy -= (pdy/pdist)*p; }
                });
                if(cdist < 100) { const p = (100 - cdist) * 0.05; b.vx += (cdx/cdist)*p; b.vy += (cdy/cdist)*p; }
                b.vx *= 0.93; b.vy *= 0.93; b.x += b.vx; b.y += b.vy;
            }
            b.x = Math.max(0, Math.min(ww - 120, b.x));
            b.y = Math.max(0, Math.min(wh - 120, b.y));
            b.el.style.transform = `translate3d(${b.x}px, ${b.y}px, 0)`;
        });
        ctx.stroke();
        requestAnimationFrame(animate);
    }

    // --- Helpers ---
    configRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            document.getElementById('display-name').innerText = data.name;
            document.getElementById('display-desc').innerText = data.desc;
            document.getElementById('display-date').innerText = data.dateStr;
            document.getElementById('display-avatar').src = data.imgData;
            document.querySelector('.bg-glass').style.backgroundImage = `url(${data.imgData})`;
            document.body.classList.add('ready');
            if (bubbles.length === 0) { resizeCanvas(); animate(0); }
        }
    });

    function openModal(b) {
        document.getElementById('m-text').innerText = b.data.content;
        document.getElementById('m-visual').innerHTML = "";
        const modal = document.getElementById('modal-overlay');
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeModal() {
        const modal = document.getElementById('modal-overlay');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 400);
    }

    function toggleLike() { document.getElementById('btn-like').classList.toggle('liked'); }
    function toggleCommentBox() { const a = document.getElementById('comment-area'); a.style.display = a.style.display === 'none' ? 'block' : 'none'; }
    function postComment() { alert("Comment posted!"); document.getElementById('comment-input').value = ""; }
    function hideConfirm() { document.getElementById('confirm-layer').style.display = 'none'; }
    function handleHardReset() { configRef.remove(); location.reload(); }

    window.addEventListener('mousemove', (e) => { if (draggedBubble) { draggedBubble.x = e.clientX - 60; draggedBubble.y = e.clientY - 60; } });
    window.addEventListener('touchmove', (e) => { if (draggedBubble) { draggedBubble.x = e.touches[0].clientX - 60; draggedBubble.y = e.touches[0].clientY - 60; e.preventDefault(); } }, {passive: false});
    window.onresize = resizeCanvas;
</script>
</body>
</html>
