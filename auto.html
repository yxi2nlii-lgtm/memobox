<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MEMOCARD</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <style>
        /* --- æ–°å¢ï¼šå°é¢ä¸æ¶Ÿæ¼ªæ ·å¼ --- */
        #cover-layer {
            position: fixed;
            inset: 0;
            z-index: 30000;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #ripple-canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
        }
        .tap-to-start {
            position: relative;
            z-index: 30001;
            color: white;
            font-size: 15px;
            letter-spacing: 2px;
            font-weight: 400;
            opacity: 0.6;
            animation: breathe 3s infinite ease-in-out;
            pointer-events: none;
        }
        @keyframes breathe {
            0%, 100% { opacity: 0.2; transform: scale(0.95); }
            50% { opacity: 0.7; transform: scale(1); }
        }

        /* --- æç®€å¯¹è¯è®¾è®¡ --- */
    #comment-list {
        text-align: left;
        max-height: 160px;
        overflow-y: auto;
        margin: 15px 0;
        font-family: 'Poppins', sans-serif;
        border-top: 1px solid rgba(0,0,0,0.05);
        padding-top: 10px;
    }

    .comment-item {
        font-size: 13px;
        line-height: 1.6;
        margin-bottom: 6px;
        color: #333;
        animation: fadeIn 0.3s ease;
    }

    .c-label-user { font-weight: 600; color: #888; margin-right: 4px; }
    .c-label-bot { font-weight: 600; color: #007AFF; margin-right: 4px; }
        
        /* --- å¼¹çª—æ ·å¼ --- */
        #confirm-layer { 
            position: fixed; inset: 0; z-index: 20000; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); 
            display: none; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; 
        }
        .confirm-card { 
            width: 85%; max-width: 320px; background: rgba(255,255,255,0.08); 
            padding: 30px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); text-align: center; 
        }
        .confirm-card h2 { font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #fff; }
        .confirm-card p { font-size: 12px; color: rgba(255,255,255,0.5); line-height: 1.6; margin-bottom: 25px; }
        .confirm-btns { display: flex; gap: 12px; }
        .c-btn { flex: 1; padding: 15px; border-radius: 15px; border: none; font-weight: 700; font-family: inherit; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .c-btn.cancel { background: rgba(255,255,255,0.1); color: white; }
        .c-btn.confirm { background: #ffffff; color: #000; }
        .c-btn.danger { background: #ff3b30; color: white; }
        
        /* --- åŸå§‹æ ·å¼ä¿æŒä¸å˜ --- */
        #setup-layer { position: fixed; inset: 0; z-index: 10000; background: #1a1a1a; display: flex; align-items: center; justify-content: center; transition: opacity 0.8s ease, transform 0.8s ease; }
        .setup-card { width: 85%; max-width: 400px; color: white; text-align: left; background: rgba(255,255,255,0.05); padding: 30px; border-radius: 30px; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .setup-card h2 { font-size: 22px; margin-bottom: 20px; font-weight: 600; font-family: 'Poppins'; }
        .input-box { margin-bottom: 20px; }
        .input-box label { display: block; font-size: 12px; opacity: 0.6; margin-bottom: 8px; text-transform: uppercase; }
        .input-box input, .input-box textarea { width: 100%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 12px; color: white; font-family: inherit; outline: none; }
        .generate-btn {
            width: 100%;
            padding: 16px;          
            border-radius: 15px;
            border: none;
            background: #ffffff;
            color: #000;
            font-weight: 600;       
            cursor: pointer;
            font-size: 18px;        
            letter-spacing: 1px;    
        }
        body.ready #setup-layer { opacity: 0; pointer-events: none; transform: translateY(-20px); }
        #reset-trigger { position: fixed; top: 20px; right: 20px; z-index: 5000; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; font-size: 10px; cursor: pointer; opacity: 0.3; }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }
        body { background: #1a1a1a; font-family: 'Poppins', sans-serif; overflow: hidden; height: 100vh; width: 100vw; touch-action: none; }
        body.state-hero #stage, body.state-hero #lineCanvas { opacity: 0; pointer-events: none; }
        .center-hub { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 4000; pointer-events: none; }
        .main-avatar { 
            width: 76px; 
            height: 76px; 
            border-radius: 50%; 
            background: rgba(255,255,255,0.1); 
            overflow: hidden; 
            transition: all 1s cubic-bezier(0.19, 1, 0.22, 1); 
            cursor: pointer; 
            pointer-events: auto; 
            z-index: 4001; 
            flex-shrink: 0; 
            transform: translateY(0);
            border: 2px solid rgba(255,255,255,0.2); 
        }
        body.state-hero .main-avatar { width: 280px; height: 280px; box-shadow: 0 30px 80px rgba(0,0,0,0.6); transform: translateY(-60px); }
        .hero-text-block { position: absolute; top: 50%; left: 0; width: 100%; padding-top: 100px; text-align: center; color: white; transition: all 0.7s ease; pointer-events: none; opacity: 0; transform: translateY(20px); }
        body.state-hero .hero-text-block { opacity: 1; transform: translateY(0); }
        .hero-text-block h1 { font-size: 26px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; line-height: 1; margin-bottom: 10px; }
        .hero-text-block .time { font-size: 13px; opacity: 0.5; letter-spacing: 1px; margin-bottom: 25px; }
        .hero-text-block .description { font-size: 14px; font-weight: 300; line-height: 1.6; max-width: 400px; margin: 0 auto; opacity: 0.8; }
        #stage, #lineCanvas { transition: opacity 1.2s ease; }
        .bg-glass { position: fixed; inset: 0; z-index: -1; background: #222; background-position: center; background-size: cover; transform: scale(1.8); filter: blur(60px) brightness(0.4); }
        #lineCanvas { position: fixed; inset: 0; z-index: 50; pointer-events: none; }
        #top-notif { position: fixed; top: -80px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 350px; background: rgba(255,255,255,0.95); padding: 12px 20px; border-radius: 40px; z-index: 5000; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; }
        #top-notif.active { transform: translateX(-50%) translateY(100px); }
        .main-avatar img { width: 100%; height: 100%; object-fit: cover; }
        #stage { position: absolute; inset: 0; z-index: 2500; pointer-events: none; }
        .bubble { position: absolute; border-radius: 50%; width: 120px; height: 120px; background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); cursor: grab; pointer-events: auto; opacity: 0; display: flex; align-items: center; justify-content: center; will-change: transform, opacity; z-index: 3000; top: 0; left: 0; }
        .bubble > * { pointer-events: none; }
        .bubble.spawned { opacity: 1; transition: opacity 1s ease-out; }
        .bubble.is-text { padding: 18px; font-size: 11px; color: #ffffff !important; text-align: center; line-height: 1.4; font-weight: 400; }
        .bubble.is-status { background: #ffffff !important; border: none; color: #000000 !important; font-weight: 700; text-transform: uppercase; font-size: 11px; }
        .unread-dot { position: absolute; top: 18px; right: 18px; width: 8px; height: 8px; background: #ff3b30; border-radius: 50%; }
        #modal-overlay { position: fixed; inset: 0; z-index: 6000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); background: rgba(0,0,0,0.3); opacity: 0; transition: 0.4s; }
        #modal-overlay.active { display: flex; opacity: 1; }
        .modal-card { background: white; padding: 30px; border-radius: 30px; width: 85%; max-width: 320px; text-align: center; position: relative; }
        .modal-actions { display: flex; justify-content: center; gap: 40px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 20px; }
        .btn-icon { background: none; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; outline: none; }
        .btn-icon svg { stroke: #999; fill: none; transition: 0.3s; }
        .btn-icon.liked svg { stroke: #ff3b30; fill: #ff3b30; }
        #comment-area { display: none; margin-top: 15px; animation: fadeIn 0.3s ease; }
        .input-group { display: flex; background: #f5f5f7; border-radius: 12px; padding: 8px 12px; align-items: center; }
        .input-group input { flex: 1; background: none; border: none; outline: none; font-size: 13px; font-family: inherit; }
        .input-group button { background: none; border: none; color: #007AFF; font-weight: 600; font-size: 13px; cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body class="state-hero">

    <div id="cover-layer" onclick="handleStart(event)">
        <canvas id="ripple-canvas"></canvas>
        <div class="tap-to-start">TAP TO ENTER MEMORY</div>
    </div>

    <div id="setup-layer">
        <div class="setup-card">
            <h2>Something Important to You...</h2>
            <div class="input-box"><label>Image</label><input type="file" id="upload-img" accept="image/*"></div>
            <div class="input-box"><label>Name</label><input type="text" id="input-name" placeholder="e.g. my rice cooker"></div>
            <div class="input-box"><label>Description</label><textarea id="input-desc" rows="3" placeholder="Tell the story..."></textarea></div>
            <button class="generate-btn" onclick="applyCustomization()">Save</button>
        </div>
    </div>

    <button id="reset-trigger" onclick="handleHardReset()">RESET ALL</button>
    <div id="top-notif"><div style="width: 8px; height: 8px; background: #ff3b30; border-radius: 50%;"></div><span id="notif-text" style="font-size: 12px; color: #333;"></span></div>
    <div class="bg-glass"></div>
    <canvas id="lineCanvas"></canvas>

    <div id="modal-overlay" onclick="closeModal()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div id="m-visual"></div>
            <p id="m-text" style="color: #333; font-size: 14px; line-height: 1.5; margin-bottom: 10px;"></p>
            <div id="comment-list"></div>
            <div class="modal-actions">
                <button class="btn-icon" id="btn-like" onclick="toggleLike()"><svg width="22" height="22" viewBox="0 0 24 24" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78l1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></button>
                <button class="btn-icon" onclick="toggleCommentBox()"><svg width="22" height="22" viewBox="0 0 24 24" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></button>
            </div>
            <div id="comment-area"><div class="input-group"><input type="text" id="comment-input" placeholder="Comment..."><button onclick="postComment()">Post</button></div></div>
        </div>
    </div>

    <div class="center-hub">
        <div class="main-avatar" onclick="document.body.classList.toggle('state-hero')"><img id="display-avatar" src=""></div>
        <div class="hero-text-block">
            <h1 id="display-name">LOADING...</h1>
            <p class="time" id="display-date"></p>
            <p class="description" id="display-desc"></p>
        </div>
    </div>
    <div id="stage"></div>

    <div id="confirm-layer">
        <div class="confirm-card">
            <h2 id="confirm-title">Title</h2>
            <p id="confirm-msg">Message goes here...</p>
            <div class="confirm-btns">
                <button class="c-btn cancel" onclick="hideConfirm()">Cancel</button>
                <button class="c-btn confirm" id="confirm-action-btn">Confirm</button>
            </div>
        </div>
    </div>

<script>
    let currentActiveBubble = null;
        // --- 1. æ–°å¢ï¼šå°é¢æ¶Ÿæ¼ªé€»è¾‘ ---
        const rCanvas = document.getElementById('ripple-canvas');
        const rCtx = rCanvas.getContext('2d');
        let ripples = [];

        function resizeRippleCanvas() {
            rCanvas.width = window.innerWidth;
            rCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeRippleCanvas);
        resizeRippleCanvas();

        function handleStart(e) {
            const x = e.clientX || e.touches[0].clientX;
            const y = e.clientY || e.touches[0].clientY;
            ripples.push({ x, y, r: 0, a: 1 });
            
            // å»¶è¿Ÿåˆ‡åœºï¼Œç­‰æ¶Ÿæ¼ªæ‰©æ•£
            setTimeout(() => {
                document.getElementById('cover-layer').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('cover-layer').style.display = 'none';
                }, 1000);
            }, 400);
        }

        function animateRipple() {
            rCtx.clearRect(0, 0, rCanvas.width, rCanvas.height);
            ripples.forEach((rp, i) => {
                rp.r += 10;
                rp.a -= 0.02;
                if (rp.a <= 0) ripples.splice(i, 1);
                rCtx.beginPath();
                rCtx.arc(rp.x, rp.y, rp.r, 0, Math.PI * 2);
                rCtx.strokeStyle = `rgba(255, 255, 255, ${rp.a})`;
                rCtx.lineWidth = 2;
                rCtx.stroke();
            });
            requestAnimationFrame(animateRipple);
        }
        animateRipple();

        // --- 1. åŸºç¡€ç‰©ç†é…ç½® ---
        const stage = document.getElementById('stage');
        const canvas = document.getElementById('lineCanvas');
        const ctx = canvas.getContext('2d');
        let bubbles = [];
        let draggedBubble = null;

// --- 2. Demo æ•°æ®é€»è¾‘ ---
        const firstMessage = { type: 'urgent', text: "Someone picked it up! Your plant has a new home." };

        const demoMessages = [
            { mode: 'img', text: "Itâ€™s all settled in on my desk and looking very vibrant.", img: "https://i.redd.it/just-joined-the-office-and-this-plant-was-on-my-desk-what-v0-g9wvhudwehsb1.jpg?width=3024&format=pjpg&auto=webp&s=85c5083e4e1f4a755cff80f210d004a7f0008389" },
            { mode: 'img', text: "A tiny new sprout just appeared; looks like itâ€™s happy here.", img: "https://s3.amazonaws.com/media.buddinghomestead.com/wp-content/uploads/2018/03/27153950/IMG_1510-001-e1522184839956.jpg" },
            { mode: 'text', text: "Itâ€™s been sunny lately, so I moved it by the window for some rays." },
            { mode: 'text', text: "Wiped the dust off the leaves; it looks so much brighter now." },
            { mode: 'text', text: "Itâ€™s doing great and barely shedding. Such a low-maintenance little guy." },
            { mode: 'text', text: "Turned it around a bit so it doesn't lean too much toward the light." },
            { mode: 'text', text: "Seeing this splash of green while I work really boosts my mood." },
            { mode: 'text', text: "Itâ€™s raining outside, but having this bit of green makes it feel cozy in hereğŸ˜„." },
            { mode: 'img', text: "Caught some nice afternoon sun on the leaves, thought Iâ€™d share.", img: "https://i.redd.it/advice-for-my-lucky-that-cant-get-great-sunlight-v0-c54gnk7weppb1.jpg?width=3024&format=pjpg&auto=webp&s=a9acb16cfa2a234ca063476e10b1e4e8581d9912" },
            { mode: 'text', text: "Fresh water and a little trim today. Looking much cleaner now." },
            { mode: 'text', text: "Environmental conditions updated: Temperature and light levels are optimal." },
            { mode: 'text', text: "Moved it to a warmer spot now that it's getting cold. Hope youâ€™re doing well." }
        ];
        let messageIndex = 0;
        let demoTimer = null; // ç”¨äºå­˜å‚¨å®šæ—¶å™¨

        // --- 3. å¯åŠ¨å‡½æ•° ---
        function applyCustomization() {
            const fileInput = document.getElementById('upload-img');
            const name = document.getElementById('input-name').value;
            const desc = document.getElementById('input-desc').value;

            if (!fileInput.files[0] || !name) {
                alert("Please select an image and name.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('display-avatar').src = e.target.result;
                document.getElementById('display-name').innerText = name;
                document.getElementById('display-desc').innerText = desc || "A shared object.";
                document.getElementById('display-date').innerText = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).toUpperCase();
                document.querySelector('.bg-glass').style.backgroundImage = `url(${e.target.result})`;

                document.body.classList.add('ready');
                initPhysics();

                setTimeout(startDemoSequence, 8000); 
            };
            reader.readAsDataURL(fileInput.files[0]);
        }

// --- 3. å¯åŠ¨å‡½æ•° (éšæœºé—´éš”ç‰ˆ) ---
        function startDemoSequence() {
            // 1. é¦–å…ˆå‘é€å”¯ä¸€çš„å¼€åœºç´§æ€¥æ¶ˆæ¯
            sendSpecificMessage(firstMessage);
            
            // 2. å®šä¹‰ä¸€ä¸ªé€’å½’å‡½æ•°æ¥å¤„ç†åç»­çš„éšæœºå‘é€
            function triggerNextMessage() {
                if (messageIndex < demoMessages.length) {
                    // è®¾å®šéšæœºåŒºé—´ï¼š4ç§’ åˆ° 10ç§’ ä¹‹é—´
                    const randomDelay = Math.floor(Math.random() * 8000) + 10000;

                    demoTimer = setTimeout(() => {
                        sendSpecificMessage(demoMessages[messageIndex]);
                        messageIndex++;
                        
                        // é€’å½’è°ƒç”¨è‡ªèº«ï¼Œå‡†å¤‡ä¸‹ä¸€æ¡
                        triggerNextMessage();
                    }, randomDelay);
                } else {
                    console.log("Transmission complete. All messages delivered.");
                    if (demoTimer) clearTimeout(demoTimer);
                }
            }

            // 3. å¼€å§‹æ‰§è¡Œé€’å½’
            triggerNextMessage();
        }

        function sendSpecificMessage(msg) {
            document.body.classList.remove('state-hero');

            if (msg.mode === 'img') {
                createCustomPhotoBubble(msg.img, msg.text);
            } else {
                createBubbleElement({ type: 'text', content: msg.text }, msg.type === 'urgent');
            }

            const notif = document.getElementById('top-notif');
            document.getElementById('notif-text').innerText = "Status update.";
            notif.classList.add('active');
            setTimeout(() => notif.classList.remove('active'), 4000);
        }

 // --- 4. æ°”æ³¡æ¸²æŸ“é€»è¾‘ (å·²æ›´æ–°ï¼šæ”¯æŒç‹¬ç«‹è¯„è®ºå­˜å‚¨) ---
 function createBubbleElement(data, isStatus) {
            const el = document.createElement('div');
            el.className = `bubble is-${data.type} ${isStatus ? 'is-status' : ''}`;
            el.innerHTML = `<div class="unread-dot"></div>${data.content}`; 
            stage.appendChild(el);
            bubbles.push(setupBubbleObject(el, data, isStatus));
            requestAnimationFrame(() => el.classList.add('spawned'));
        }

        function createCustomPhotoBubble(imgSrc, caption) {
            const el = document.createElement('div');
            el.className = `bubble is-img`;
            el.innerHTML = `
                <div class="unread-dot"></div>
                <img src="${imgSrc}" style="width:100%; height:100%; object-fit:cover; border-radius:50%; pointer-events:none;">
            `;
            stage.appendChild(el);
            bubbles.push(setupBubbleObject(el, { type: 'img', content: caption, rawImg: imgSrc }, false));
            requestAnimationFrame(() => el.classList.add('spawned'));
        }

function setupBubbleObject(el, data, isStatus) {
            const ww = window.innerWidth, wh = window.innerHeight;
            const bObj = { 
                el, x: ww/2-60, y: wh/2-60, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, 
                isDragged: false, data, isStatus,
                comments: [] 
            };
            
            let startX, startY, startTime;

            const down = (x, y) => { 
                startX = x; 
                startY = y; 
                startTime = Date.now(); 
                draggedBubble = bObj; 
                bObj.isDragged = true; 
                // è§†è§‰åé¦ˆï¼šæŒ‰ä¸‹æ—¶ç¨å¾®ç¼©å°
                el.style.transition = "transform 0.1s";
            };

            const up = (x, y) => {
                if(!bObj.isDragged) return;
                
                const moveDist = Math.hypot(x - startX, y - startY);
                const duration = Date.now() - startTime;

                // --- ä¼˜åŒ–åˆ¤å®šæ¡ä»¶ ---
                // 1. è·ç¦»ä» 20 æ”¾å¤§åˆ° 40 (é˜²æ­¢æ‰‹æŒ‡è‚‰åšå¯¼è‡´çš„å¾®å°ä½ç§»åˆ¤å®šä¸ºæ‹–æ‹½)
                // 2. æ—¶é—´ä» 300ms æ”¾å¤§åˆ° 500ms (å…è®¸ç¨å¾®æ…¢ä¸€ç‚¹çš„ç‚¹å‡»)
                if(moveDist < 40 && duration < 500) {
                    openModal(bObj);
                }
                
                bObj.isDragged = false; 
                draggedBubble = null;
                el.style.transition = ""; // æ¢å¤ç‰©ç†å¼•æ“æ§åˆ¶
            };

            // é¼ æ ‡äº‹ä»¶
            el.addEventListener('mousedown', e => down(e.clientX, e.clientY));
            window.addEventListener('mouseup', e => up(e.clientX, e.clientY));

            // è§¦æ‘¸äº‹ä»¶ (é’ˆå¯¹æ‰‹æœºä¼˜åŒ–)
            el.addEventListener('touchstart', e => {
                down(e.touches[0].clientX, e.touches[0].clientY);
            }, {passive: true});

            window.addEventListener('touchend', e => { 
                if(e.changedTouches[0]) {
                    up(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
                }
            });
            
            return bObj;
        }

// --- 5. åŠ¨ç”»å¼•æ“ ---
        function animate(time) {
            const dpr = window.devicePixelRatio || 1;
            ctx.clearRect(0, 0, canvas.width/dpr, canvas.height/dpr);
            const ww = window.innerWidth, wh = window.innerHeight;
            
            // --- æ ¸å¿ƒä¿®æ”¹ç‚¹ï¼šé”å®š Avatar ä¸­å¿ƒç‚¹ ---
            // ä¸å†ä½¿ç”¨ getBoundingClientRectï¼Œå› ä¸ºå®ƒå— DOM å¸ƒå±€å˜åŒ–å½±å“
            // ç›´æ¥ä½¿ç”¨å±å¹•ä¸­å¿ƒä½œä¸ºç‰©ç†å‚è€ƒç‚¹
            let cx = ww / 2;
            let cy = wh / 2;
            
            // å¦‚æœå¤„äº Hero çŠ¶æ€ï¼ˆå¤§å¤´åƒï¼‰ï¼Œç¨å¾®å‘ä¸Šåç§»
            if (document.body.classList.contains('state-hero')) {
                cy = wh / 2 - 60; 
            }
            
            ctx.beginPath(); 
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)'; 
            ctx.lineWidth = 1.5;
            
            bubbles.forEach((b, i) => {
                const currX = b.x+60, currY = b.y+60;
                let px = cx, py = cy; 
                if(i > 0) { 
                    px = bubbles[i-1].x+60; 
                    py = bubbles[i-1].y+60; 
                }
                
                ctx.moveTo(px, py); 
                ctx.quadraticCurveTo((px+currX)/2, (py+currY)/2 + Math.sin(time*0.002+i)*10, currX, currY);
                
                if (!b.isDragged) {
                    const dx = currX-cx, dy = currY-cy, dist = Math.sqrt(dx*dx+dy*dy)||1;
                    b.vx += (-dy/dist)*0.0008 + (cx-currX)*0.00003;
                    
                    bubbles.forEach((b2, j) => {
                        if(i===j) return;
                        const pdx = (b2.x+60)-currX, pdy = (b2.y+60)-currY, pdist = Math.hypot(pdx, pdy)||1;
                        if(pdist<135) { 
                            const p=(135-pdist)*0.02; 
                            b.vx-=(pdx/pdist)*p; 
                            b.vy-=(pdy/pdist)*p; 
                        }
                    });
                    
                    if(dist<100) { 
                        const p=(100-dist)*0.05; 
                        b.vx+=(dx/dist)*p; 
                        b.vy+=(dy/dist)*p; 
                    }
                    
                    b.vx*=0.92; b.vy*=0.92; b.x+=b.vx; b.y+=b.vy;
                }
                // è¾¹ç•Œæ£€æŸ¥ï¼šç¡®ä¿æ°”æ³¡ä¸è¶…å‡ºå½“å‰å¯è§†çª—å£
                b.x = Math.max(0, Math.min(ww-120, b.x)); 
                b.y = Math.max(0, Math.min(wh-120, b.y));
                b.el.style.transform = `translate3d(${b.x}px, ${b.y}px, 0)`;
            });
            ctx.stroke(); 
            requestAnimationFrame(animate);
        }

        function initPhysics() { resizeCanvas(); animate(0); }
        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * dpr; canvas.height = window.innerHeight * dpr;
            ctx.scale(dpr, dpr);
            canvas.style.width = window.innerWidth + 'px'; canvas.style.height = window.innerHeight + 'px';
        }
        window.onresize = resizeCanvas;
        window.addEventListener('mousemove', e => { if(draggedBubble){ draggedBubble.x=e.clientX-60; draggedBubble.y=e.clientY-60; } });
        window.addEventListener('touchmove', e => { if(draggedBubble){ const t=e.touches[0]; draggedBubble.x=t.clientX-60; draggedBubble.y=t.clientY-60; e.preventDefault(); } }, {passive: false});

// --- 6. äº¤äº’ç»„ä»¶ (å·²æ›´æ–°ï¼šæ”¯æŒç‹¬ç«‹è¯„è®ºè®°å¿†) ---

        function openModal(b) {
            currentActiveBubble = b; // é”å®šå½“å‰æ°”æ³¡å¯¹è±¡
            
            // 1. æ¸…ç©ºæ—§è¯„è®ºæ˜¾ç¤ºï¼Œå¹¶åŠ è½½è¯¥æ°”æ³¡ä¸“å±çš„è¯„è®ºè®°å½•
            const list = document.getElementById('comment-list');
            if(list) {
                list.innerHTML = ""; 
                if(b.comments && b.comments.length > 0) {
                    b.comments.forEach(c => {
                        addCommentToUI(c.text, c.type, false); // false è¡¨ç¤ºä»…åŠ è½½ï¼Œä¸é‡å¤å­˜å…¥
                    });
                }
            }

            // 2. ç§»é™¤çº¢ç‚¹
            const targetEl = b.element || b.el; 
            if (targetEl) {
                const dot = targetEl.querySelector('.unread-dot');
                if (dot) dot.remove();
            }

            // 3. æ¸²æŸ“å›¾ç‰‡æˆ–æ–‡å­—å†…å®¹
            const visual = document.getElementById('m-visual');
            visual.innerHTML = (b.data.type==='img' || b.data.rawImg) ? `<img src="${b.data.rawImg}" style="width:100%; border-radius:15px; margin-bottom:15px;">` : "";
            document.getElementById('m-text').innerText = b.data.content || "";
            
            // 4. æ˜¾ç¤ºå¼¹çª—
            document.getElementById('modal-overlay').style.display = 'flex';
            setTimeout(() => document.getElementById('modal-overlay').classList.add('active'), 10);
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
            setTimeout(() => {
                document.getElementById('modal-overlay').style.display = 'none';
                currentActiveBubble = null; // å…³é—­æ—¶æ¸…é™¤é”å®šçŠ¶æ€
            }, 400);
        }

        function toggleLike() { 
            document.getElementById('btn-like').classList.toggle('liked'); 
        }

        function toggleCommentBox() { 
            const a = document.getElementById('comment-area'); 
            a.style.display = a.style.display === 'none' ? 'block' : 'none'; 
        }

        function postComment() { 
            const input = document.getElementById('comment-input'); 
            const val = input.value.trim();
            
            if(val && currentActiveBubble){ 
                // 1. ç«‹å³æ˜¾ç¤ºå¹¶å°†è¯„è®ºå­˜å…¥è¯¥æ°”æ³¡çš„ç‹¬ç«‹è®°å¿†
                addCommentToUI(val, 'user', true);
                input.value = ""; 

                // 2. 5ç§’åè§¦å‘ Holder å›å¤
                setTimeout(() => {
                    const reply = "hahah, :)";
                    // å°†å›å¤ä¹Ÿå­˜å…¥è¯¥æ°”æ³¡çš„ç‹¬ç«‹è®°å¿†
                    addCommentToUI(reply, 'bot', true);
                }, 5000);
            } 
        }

        function addCommentToUI(text, type, shouldSave) {
            // å¦‚æœéœ€è¦ä¿å­˜ï¼Œå°±å­˜å…¥å½“å‰æ´»è·ƒæ°”æ³¡çš„æ•°ç»„é‡Œ
            if(shouldSave && currentActiveBubble) {
                currentActiveBubble.comments.push({ text: text, type: type });
            }

            // æ¸²æŸ“åˆ° UI ä¸Šï¼ˆåªæœ‰å¼¹çª—å¼€ç€ä¸”æ˜¯åŒä¸€ä¸ªæ°”æ³¡æ—¶æ‰åˆ·å‡ºï¼Œæˆ–è€…åˆå§‹åŒ–åŠ è½½æ—¶åˆ·å‡ºï¼‰
            const list = document.getElementById('comment-list');
            if(!list) return;

            const d = document.createElement('div');
            d.className = 'comment-item';
            if(type === 'user') {
                d.innerHTML = `<span class="c-label-user">You:</span>${text}`;
            } else {
                d.innerHTML = `<span class="c-label-bot">Holder:</span>${text}`;
            }
            
            list.appendChild(d);
            list.scrollTop = list.scrollHeight; 
        }

        function handleHardReset() { location.reload(); }
    </script>
</body>
</html>
