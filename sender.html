<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <title>BAMBOO FLOW - FLOW</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>



    <style>

        /* --- 核心样式统一 --- */

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }

        body { background: #1a1a1a; font-family: 'Poppins', sans-serif; overflow: hidden; height: 100vh; width: 100vw; touch-action: none; color: white; }

        

        /* 连线与背景 */

        #lineCanvas { position: fixed; inset: 0; z-index: 50; pointer-events: none; }

        .bg-glass { position: fixed; inset: 0; z-index: -1; background: #222; background-position: center; background-size: cover; transform: scale(1.8); filter: blur(60px) brightness(0.4); }

        

        /* 介绍信息 */

        .intro-container { position: fixed; top: 18%; width: 100%; text-align: center; z-index: 4000; pointer-events: none; padding: 0 40px; }

        #display-name { font-size: 19px; font-weight: 600; margin-bottom: 8px; opacity: 0; transition: opacity 1s; text-shadow: 0 4px 15px rgba(0,0,0,0.5); }

        #display-desc { font-size: 11px; opacity: 0; transition: opacity 1s 0.5s; line-height: 1.6; color: rgba(255,255,255,0.6); max-width: 260px; margin: 0 auto; font-style: italic; }



        /* 中心区域与头像 */

        .center-hub { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 4000; pointer-events: none; }

        .avatar-wrapper { position: relative; pointer-events: auto; cursor: pointer; display: flex; flex-direction: column; align-items: center; }

        .main-avatar { 

            width: 84px; height: 84px; border-radius: 50%; background: rgba(255,255,255,0.1); 

            overflow: hidden; z-index: 4001; transition: transform 0.3s; 

            border: 2px solid rgba(255,255,255,0.2); /* 统一的描边 */

        }

        .main-avatar img { width: 100%; height: 100%; object-fit: cover; }

        

        /* 涟漪动画 */

        .ripple { position: absolute; width: 84px; height: 84px; border: 2px solid rgba(255,255,255,0.4); border-radius: 50%; animation: ripple-effect 2.5s infinite; z-index: 4000; }

        @keyframes ripple-effect { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(2.2); opacity: 0; } }



        #status-hint { margin-top: 20px; font-size: 9px; letter-spacing: 2px; opacity: 0.5; animation: blink 2s infinite; }

        @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.7; } }



        /* 气泡样式 */

        #stage { position: absolute; inset: 0; z-index: 2500; pointer-events: none; }

        .bubble { position: absolute; border-radius: 50%; width: 120px; height: 120px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); cursor: grab; pointer-events: auto; opacity: 0; display: flex; align-items: center; justify-content: center; will-change: transform, opacity; z-index: 3000; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }

        .bubble.spawned { opacity: 1; transition: opacity 1s ease-out; }

        .bubble.is-text { padding: 18px; font-size: 11px; color: #000000 !important; text-align: center; line-height: 1.4; font-weight: 400; }

        .bubble.is-status { background: #ffffff; border: none; color: #000000 !important; font-weight: 700; text-transform: uppercase; font-size: 10px; }

        .bubble.is-plus { border: 2px dashed rgba(255,255,255,0.4); background: rgba(255,255,255,0.1); font-size: 32px; color: white; cursor: pointer; backdrop-filter: none; box-shadow: none; }



        /* 弹窗样式 */

        #confirm-layer { position: fixed; inset: 0; z-index: 20000; background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); display: none; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; }

        .confirm-card { width: 85%; max-width: 320px; background: rgba(255,255,255,0.08); padding: 30px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }

        .confirm-card h2 { font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #fff; }

        .confirm-card p { font-size: 12px; color: rgba(255,255,255,0.5); line-height: 1.6; margin-bottom: 25px; }

        .confirm-btns { display: flex; gap: 12px; }

        .c-btn { flex: 1; padding: 15px; border-radius: 15px; border: none; font-weight: 700; font-family: inherit; font-size: 12px; cursor: pointer; transition: 0.2s; }

        .c-btn.cancel { background: rgba(255,255,255,0.1); color: white; }

        .c-btn.confirm { background: #ffffff; color: #000; }

        .c-btn.danger { background: #ff3b30; color: white; }



        #menu-layer { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px); }

        .menu-card { width: 85%; max-width: 350px; background: #222; padding: 25px; border-radius: 25px; border: 1px solid #333; }

        .input-box { margin-bottom: 15px; }

        .input-box label { display: block; font-size: 10px; opacity: 0.5; margin-bottom: 5px; }

        .input-box input, .input-box textarea { width: 100%; background: #333; border: none; border-radius: 10px; padding: 12px; color: white; outline: none; font-family: inherit; }

        .send-btn { width: 100%; padding: 15px; border-radius: 12px; border: none; background: white; font-weight: 700; cursor: pointer; }

        #reset-btn { position: fixed; top: 40px; right: 20px; z-index: 5000; background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 20px; font-size: 9px; cursor: pointer; }

    </style>

</head>

<body>



    <div class="bg-glass" id="bg-img"></div>

    <canvas id="lineCanvas"></canvas>

    <button id="reset-btn" onclick="showResetConfirm()">RESET SYSTEM</button>



    <div class="intro-container" id="intro-box">

        <h2 id="display-name">Hi stranger...</h2>

        <p id="display-desc"></p>

    </div>



    <div class="center-hub">

        <div class="avatar-wrapper" onclick="showPickupConfirm()">

            <div class="ripple"></div>

            <div class="ripple"></div>

            <div class="main-avatar">

                <img id="display-avatar" src="">

            </div>

            <div id="status-hint">CLICK TO PICK IT UP</div>

        </div>

    </div>



    <div id="stage"></div>



    <div id="confirm-layer">

        <div class="confirm-card">

            <h2 id="confirm-title">Title</h2>

            <p id="confirm-msg">Message goes here...</p>

            <div class="confirm-btns">

                <button class="c-btn cancel" onclick="hideConfirm()">Cancel</button>

                <button class="c-btn confirm" id="confirm-action-btn">Confirm</button>

            </div>

        </div>

    </div>



    <div id="menu-layer" onclick="this.style.display='none'">

        <div class="menu-card" onclick="event.stopPropagation()">

            <div class="input-box"><label>MESSAGE / CAPTION</label><textarea id="msg-text" rows="3"></textarea></div>

            <div class="input-box"><label>ADD PHOTO (OPTIONAL)</label><input type="file" id="msg-img" accept="image/*"></div>

            <button class="send-btn" onclick="handleNormalSend()">SEND INTO FLOW</button>

        </div>

    </div>



    <script>

        // --- Firebase 配置 ---

        const firebaseConfig = {

            apiKey: "AIzaSyC7OLP-hG6ekdLQewLrB9BFGQCuzRlbnTE",

            authDomain: "memo-6a74a.firebaseapp.com",

            projectId: "memo-6a74a",

            storageBucket: "memo-6a74a.firebasestorage.app",

            messagingSenderId: "487014379920",

            appId: "1:487014379920:web:aa34c9662846c0a3d60315",

            databaseURL: "https://memo-6a74a-default-rtdb.firebaseio.com/"

        };

        firebase.initializeApp(firebaseConfig);

        const db = firebase.database();

        const configRef = db.ref('object_config');

        const msgRef = db.ref('flow_messages');



        const stage = document.getElementById('stage');

        const canvas = document.getElementById('lineCanvas');

        const ctx = canvas.getContext('2d');

        let bubbles = [];

        let hasPickedUp = false;



        // --- 弹窗逻辑 ---

        function showConfirm(title, msg, onConfirm, isDanger = false) {

            const layer = document.getElementById('confirm-layer');

            const btn = document.getElementById('confirm-action-btn');

            document.getElementById('confirm-title').innerText = title;

            document.getElementById('confirm-msg').innerText = msg;

            layer.style.display = 'flex';

            setTimeout(() => layer.style.opacity = '1', 10);

            btn.className = isDanger ? 'c-btn danger' : 'c-btn confirm';

            btn.onclick = () => { onConfirm(); hideConfirm(); };

        }



        function hideConfirm() {

            const layer = document.getElementById('confirm-layer');

            layer.style.opacity = '0';

            setTimeout(() => layer.style.display = 'none', 300);

        }



        function showPickupConfirm() {

            if (hasPickedUp) return;

            showConfirm("Pick Up Memory?", "Are you sure you want to pick up this object and see its flow?", () => {

                msgRef.push({ mode: 'text', text: "SOME ONE PICKED IT UP", type: 'urgent', time: Date.now() });

            });

        }



        function showResetConfirm() {

            showConfirm("Reset System?", "This will clear all messages and return to stranger mode.", () => {

                msgRef.remove().then(() => location.reload());

            }, true);

        }



        // --- 初始化与同步 ---

        window.onload = function() {

            configRef.on('value', (snapshot) => {

                const data = snapshot.val();

                if (data) {

                    document.getElementById('display-avatar').src = data.imgData;

                    document.getElementById('bg-img').style.backgroundImage = `url(${data.imgData})`;

                    const name = data.userName || data.name || "Someone";

                    const desc = data.userDesc || data.desc || "";

                    document.getElementById('display-name').innerText = `Hi stranger, this is ${name}`;

                    document.getElementById('display-desc').innerText = desc ? `“${desc}”` : "";

                    if (!hasPickedUp) {

                        document.getElementById('display-name').style.opacity = 1;

                        document.getElementById('display-desc').style.opacity = 1;

                    }

                }

            });



            initPhysics();



            msgRef.on('value', (snapshot) => {

                const val = snapshot.val();

                let foundPickup = false;

                if (val) {

                    Object.values(val).forEach(m => { if (m.text === "SOME ONE PICKED IT UP") foundPickup = true; });

                }

                hasPickedUp = foundPickup;

                

                const display = hasPickedUp ? 'none' : 'block';

                document.getElementById('status-hint').style.display = display;

                document.querySelectorAll('.ripple').forEach(r => r.style.display = display);

                if(hasPickedUp) document.getElementById('intro-box').style.display = 'none';

                

                refreshState(val);

            });

        };



        function refreshState(allMsgs) {

            bubbles.forEach(b => b.el.remove());

            bubbles = [];

            if (allMsgs) {

                Object.values(allMsgs).forEach(msg => {

                    if (msg.type === 'clear_all') return;

                    if (msg.mode === 'img') createCustomPhotoBubble(msg.img, msg.text);

                    else {

                        let content = msg.text === "SOME ONE PICKED IT UP" ? "I PICKED IT UP" : msg.text;

                        createBubbleElement({ type: 'text', content: content }, msg.type === 'urgent');

                    }

                });

                if (hasPickedUp) createPlusBubble();

            }

        }



        // --- 气泡创建 ---

        function createPlusBubble() {

            const el = document.createElement('div');

            el.className = 'bubble is-plus'; el.innerHTML = '+';

            el.onclick = () => document.getElementById('menu-layer').style.display = 'flex';

            stage.appendChild(el);

            bubbles.push(setupBubbleObject(el, { type: 'plus' }, false));

            requestAnimationFrame(() => el.classList.add('spawned'));

        }



        function createBubbleElement(data, isStatus) {

            const el = document.createElement('div');

            const isPickup = data.content.includes("PICKED IT UP");

            el.className = `bubble ${isPickup ? 'is-status' : 'is-text'}`;

            el.innerHTML = data.content;

            stage.appendChild(el);

            bubbles.push(setupBubbleObject(el, data, isPickup));

            requestAnimationFrame(() => el.classList.add('spawned'));

        }



        function createCustomPhotoBubble(imgSrc, caption) {

            const el = document.createElement('div');

            el.className = `bubble is-img`;

            el.innerHTML = `<img src="${imgSrc}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;

            stage.appendChild(el);

            bubbles.push(setupBubbleObject(el, { type: 'img', content: caption }, false));

            requestAnimationFrame(() => el.classList.add('spawned'));

        }



        // --- 物理引擎 ---

        function setupBubbleObject(el, data, isStatus) {

            const ww = window.innerWidth, wh = window.innerHeight;

            const initialX = ww/2 + (Math.random()-0.5)*150 - 60;

            const initialY = wh/2 + (Math.random()-0.5)*150 - 60;

            const bObj = { el, x: initialX, y: initialY, vx: 0, vy: 0, isDragged: false, data, isStatus };

            

            const start = (e) => { bObj.isDragged = true; };

            const move = (e) => {

                if (!bObj.isDragged) return;

                const t = e.touches ? e.touches[0] : e;

                bObj.x = t.clientX - 60; bObj.y = t.clientY - 60;

            };

            const end = () => { bObj.isDragged = false; };



            el.addEventListener('mousedown', start);

            el.addEventListener('touchstart', start, {passive: false});

            window.addEventListener('mousemove', move);

            window.addEventListener('touchmove', move, {passive: false});

            window.addEventListener('mouseup', end);

            window.addEventListener('touchend', end);

            return bObj;

        }



        function animate(time) {

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const ww = window.innerWidth, wh = window.innerHeight, cx = ww / 2, cy = wh / 2;

            

            // 连线对齐修正：严格从头像中心出发

            const startX = cx;

            const startY = cy;



            ctx.beginPath();

            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';

            ctx.lineWidth = 1.5;



            bubbles.forEach((b, i) => {

                const currX = b.x + 60, currY = b.y + 60;

                let prevX = startX, prevY = startY;

                if (i > 0) { prevX = bubbles[i-1].x + 60; prevY = bubbles[i-1].y + 60; }



                ctx.moveTo(prevX, prevY);

                ctx.quadraticCurveTo((prevX + currX)/2, (prevY + currY)/2 + Math.sin(time*0.002+i)*10, currX, currY);



                if (!b.isDragged) {

                    const cdx = currX - cx, cdy = currY - cy, cdist = Math.sqrt(cdx*cdx + cdy*cdy) || 1;

                    b.vx += (-cdy/cdist) * 0.0008; b.vx += (cx - currX) * 0.00003;

                    

                    bubbles.forEach((b2, j) => {

                        if(i === j) return;

                        const pdx = (b2.x+60) - currX, pdy = (b2.y+60) - currY, pdist = Math.hypot(pdx, pdy) || 1;

                        if(pdist < 135) { 

                            const p = (135 - pdist) * 0.02; 

                            b.vx -= (pdx/pdist)*p; b.vy -= (pdy/pdist)*p; 

                        }

                    });

                    if(cdist < 100) { 

                        const p = (100 - cdist) * 0.05; 

                        b.vx += (cdx/cdist)*p; b.vy += (cdy/cdist)*p; 

                    }

                    b.vx *= 0.92; b.vy *= 0.92; b.x += b.vx; b.y += b.vy;

                }

                b.x = Math.max(0, Math.min(ww - 120, b.x));

                b.y = Math.max(0, Math.min(wh - 120, b.y));

                b.el.style.transform = `translate3d(${b.x}px, ${b.y}px, 0)`;

            });

            ctx.stroke();

            requestAnimationFrame(animate);

        }



        function initPhysics() { 

            const dpr = window.devicePixelRatio || 1;

            canvas.width = window.innerWidth * dpr;

            canvas.height = window.innerHeight * dpr;

            ctx.scale(dpr, dpr);

            canvas.style.width = window.innerWidth + 'px';

            canvas.style.height = window.innerHeight + 'px';

            animate(0); 

        }



        function handleNormalSend() {

            const text = document.getElementById('msg-text').value;

            const file = document.getElementById('msg-img').files[0];

            if (!text && !file) return;

            if (file) {

                const reader = new FileReader();

                reader.onload = (e) => { msgRef.push({ mode: 'img', img: e.target.result, text, type: 'normal', time: Date.now() }); };

                reader.readAsDataURL(file);

            } else {

                msgRef.push({ mode: 'text', text, type: 'normal', time: Date.now() });

            }

            document.getElementById('menu-layer').style.display = 'none';

            document.getElementById('msg-text').value = '';

            document.getElementById('msg-img').value = '';

        }



        window.onresize = initPhysics;

    </script>

</body>

</html>
