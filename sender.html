<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BAMBOO FLOW - SENDER</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }
        body { background: #1a1a1a; font-family: 'Poppins', sans-serif; overflow: hidden; height: 100vh; width: 100vw; touch-action: none; color: white; }
        #stage { position: absolute; inset: 0; z-index: 2500; pointer-events: none; }
        #lineCanvas { position: fixed; inset: 0; z-index: 50; pointer-events: none; }
        .bg-glass { position: fixed; inset: 0; z-index: -1; background: #222; background-position: center; background-size: cover; transform: scale(1.8); filter: blur(60px) brightness(0.4); }
        
        /* 介绍区域样式 */
        .intro-container { position: fixed; top: 22%; width: 100%; text-align: center; z-index: 4000; pointer-events: none; padding: 0 40px; }
        #display-name { font-size: 18px; font-weight: 600; margin-bottom: 8px; opacity: 0; transition: opacity 1s; }
        #display-desc { font-size: 11px; opacity: 0; transition: opacity 1s 0.5s; line-height: 1.6; color: rgba(255,255,255,0.6); }

        .center-hub { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 4000; pointer-events: none; }
        .main-avatar { width: 84px; height: 84px; border-radius: 50%; background: rgba(255,255,255,0.1); overflow: hidden; z-index: 4001; pointer-events: auto; cursor: pointer; transition: transform 0.3s ease; border: 2px solid rgba(255,255,255,0.2); }
        .main-avatar:active { transform: scale(0.9); }
        .main-avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        #status-hint { margin-top: 20px; font-size: 9px; letter-spacing: 2px; opacity: 0.5; animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.7; } }

        .bubble { position: absolute; border-radius: 50%; width: 120px; height: 120px; background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); cursor: grab; pointer-events: auto; opacity: 0; display: flex; align-items: center; justify-content: center; will-change: transform, opacity; z-index: 3000; }
        .bubble.spawned { opacity: 1; transition: opacity 1s ease-out; }
        .bubble.is-text { padding: 18px; font-size: 11px; color: rgba(255,255,255,0.8); text-align: center; line-height: 1.4; }
        .bubble.is-status { background: #ffffff; border: none; color: #000; font-weight: 700; text-transform: uppercase; font-size: 10px; }
        .bubble.is-plus { border: 2px dashed rgba(255,255,255,0.4); background: none; font-size: 32px; color: white; cursor: pointer; backdrop-filter: none; }

        #menu-layer { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .menu-card { width: 85%; max-width: 350px; background: #222; padding: 25px; border-radius: 25px; border: 1px solid #333; }
        .input-box { margin-bottom: 15px; }
        .input-box label { display: block; font-size: 10px; opacity: 0.5; margin-bottom: 5px; }
        .input-box input, .input-box textarea { width: 100%; background: #333; border: none; border-radius: 10px; padding: 12px; color: white; outline: none; font-family: inherit; }
        .send-btn { width: 100%; padding: 12px; border-radius: 10px; border: none; background: white; font-weight: 600; cursor: pointer; }
        
        #reset-btn { position: fixed; top: 40px; right: 20px; z-index: 5000; background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 20px; font-size: 9px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="bg-glass" id="bg-img"></div>
    <canvas id="lineCanvas"></canvas>
    
    <button id="reset-btn" onclick="clearAll()">RESET SYSTEM</button>

    <div class="intro-container">
        <h2 id="display-name">Hi stranger...</h2>
        <p id="display-desc"></p>
    </div>

    <div class="center-hub">
        <div class="main-avatar" onclick="handleInitialPickup()">
            <img id="display-avatar" src="">
        </div>
        <div id="status-hint">CLICK TO PICK IT UP</div>
    </div>

    <div id="stage"></div>

    <div id="menu-layer" onclick="this.style.display='none'">
        <div class="menu-card" onclick="event.stopPropagation()">
            <div class="input-box"><label>MESSAGE / CAPTION</label><textarea id="msg-text" rows="3"></textarea></div>
            <div class="input-box"><label>ADD PHOTO (OPTIONAL)</label><input type="file" id="msg-img" accept="image/*"></div>
            <button class="send-btn" onclick="handleNormalSend()">SEND INTO FLOW</button>
        </div>
    </div>

    <script>
        // --- 1. Firebase 配置 ---
        const firebaseConfig = {
            apiKey: "AIzaSyC7OLP-hG6ekdLQewLrB9BFGQCuzRlbnTE",
            authDomain: "memo-6a74a.firebaseapp.com",
            projectId: "memo-6a74a",
            storageBucket: "memo-6a74a.firebasestorage.app",
            messagingSenderId: "487014379920",
            appId: "1:487014379920:web:aa34c9662846c0a3d60315",
            databaseURL: "https://memo-6a74a-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const configRef = db.ref('object_config');
        const msgRef = db.ref('flow_messages');

        const stage = document.getElementById('stage');
        const canvas = document.getElementById('lineCanvas');
        const ctx = canvas.getContext('2d');
        let bubbles = [];
        let draggedBubble = null;
        let hasPickedUp = false;

        // --- 2. 核心逻辑 ---
        window.onload = function() {
            // 读取名字、描述、头像
            configRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('display-avatar').src = data.imgData || '';
                    document.getElementById('bg-img').style.backgroundImage = `url(${data.imgData})`;
                    const nameEl = document.getElementById('display-name');
                    const descEl = document.getElementById('display-desc');
                    nameEl.innerText = `Hi stranger, this is ${data.userName || 'Someone'}`;
                    descEl.innerText = data.userDesc || '';
                    nameEl.style.opacity = 1;
                    descEl.style.opacity = 1;
                }
            });

            initPhysics();

            // 监听消息同步
            msgRef.on('value', (snapshot) => {
                const val = snapshot.val();
                // 检查是否已经捡起 (寻找特定的拾取消息)
                hasPickedUp = false;
                if (val) {
                    Object.values(val).forEach(m => {
                        if (m.text === "SOME ONE PICKED IT UP") hasPickedUp = true;
                    });
                }
                
                // 状态 UI 切换
                document.getElementById('status-hint').style.display = hasPickedUp ? 'none' : 'block';
                refreshState(val);
            });
        };

        function refreshState(allMsgs) {
            bubbles.forEach(b => b.el.remove());
            bubbles = [];

            if (allMsgs) {
                Object.values(allMsgs).forEach(msg => {
                    if (msg.type === 'clear_all') return;
                    if (msg.mode === 'img') {
                        createCustomPhotoBubble(msg.img, msg.text);
                    } else {
                        // Sender 视角：如果是拾取消息，显示为 "I PICKED IT UP"
                        let content = msg.text;
                        if (content === "SOME ONE PICKED IT UP") content = "I PICKED IT UP";
                        createBubbleElement({ type: 'text', content: content }, msg.type === 'urgent');
                    }
                });
                // 如果已拾取，显示添加按钮
                if (hasPickedUp) createPlusBubble();
            }
        }

        function handleInitialPickup() {
            if (hasPickedUp) return;
            msgRef.push({ 
                mode: 'text', 
                text: "SOME ONE PICKED IT UP", 
                type: 'urgent',
                time: Date.now()
            });
        }

        function handleNormalSend() {
            const text = document.getElementById('msg-text').value;
            const file = document.getElementById('msg-img').files[0];
            if (!text && !file) return;

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    msgRef.push({ mode: 'img', img: e.target.result, text, type: 'normal', time: Date.now() });
                };
                reader.readAsDataURL(file);
            } else {
                msgRef.push({ mode: 'text', text, type: 'normal', time: Date.now() });
            }
            document.getElementById('menu-layer').style.display = 'none';
            document.getElementById('msg-text').value = '';
        }

        function clearAll() {
            if(confirm("Reset everything? This will return to stranger mode.")) {
                msgRef.set({ reset_signal: { type: 'clear_all', time: Date.now() } });
                location.reload();
            }
        }

        // --- 3. 物理引擎 (1:1 还原) ---
        function createPlusBubble() {
            const el = document.createElement('div');
            el.className = 'bubble is-plus'; el.innerHTML = '+';
            el.onclick = () => document.getElementById('menu-layer').style.display = 'flex';
            stage.appendChild(el);
            bubbles.push(setupBubbleObject(el, { type: 'plus' }, false));
            requestAnimationFrame(() => el.classList.add('spawned'));
        }

        function createBubbleElement(data, isStatus) {
            const el = document.createElement('div');
            const isPickup = data.content.includes("PICKED IT UP");
            el.className = `bubble is-text ${isPickup ? 'is-status' : ''}`;
            el.innerHTML = data.content;
            stage.appendChild(el);
            bubbles.push(setupBubbleObject(el, data, isPickup));
            requestAnimationFrame(() => el.classList.add('spawned'));
        }

        function createCustomPhotoBubble(imgSrc, caption) {
            const el = document.createElement('div');
            el.className = `bubble is-img`;
            el.innerHTML = `<img src="${imgSrc}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
            stage.appendChild(el);
            bubbles.push(setupBubbleObject(el, { type: 'img', content: caption }, false));
            requestAnimationFrame(() => el.classList.add('spawned'));
        }

        function setupBubbleObject(el, data, isStatus) {
            const ww = window.innerWidth, wh = window.innerHeight;
            const initialX = ww/2 + (Math.random()-0.5)*150 - 60;
            const initialY = wh/2 + (Math.random()-0.5)*150 - 60;
            const bObj = { el, x: initialX, y: initialY, vx: 0, vy: 0, isDragged: false, data, isStatus };
            
            const start = (e) => { const t = e.touches ? e.touches[0] : e; draggedBubble = bObj; bObj.isDragged = true; };
            const move = (e) => {
                if (!bObj.isDragged) return;
                const t = e.touches ? e.touches[0] : e;
                bObj.x = t.clientX - 60; bObj.y = t.clientY - 60;
            };
            const end = () => { bObj.isDragged = false; draggedBubble = null; };

            el.addEventListener('mousedown', start);
            el.addEventListener('touchstart', start, {passive: false});
            window.addEventListener('mousemove', move);
            window.addEventListener('touchmove', move, {passive: false});
            window.addEventListener('mouseup', end);
            window.addEventListener('touchend', end);
            return bObj;
        }

        function animate(time) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const ww = window.innerWidth, wh = window.innerHeight, cx = ww / 2, cy = wh / 2;
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            bubbles.forEach((b, i) => {
                let px = cx, py = cy;
                if (i > 0) { px = bubbles[i-1].x + 60; py = bubbles[i-1].y + 60; }
                const currX = b.x + 60, currY = b.y + 60;
                const dx = currX - px, dy = currY - py, dist = Math.sqrt(dx*dx + dy*dy) || 1;
                if (dist > 300 && !b.isDragged) {
                    const pull = (dist - 300) * 0.02;
                    b.vx -= (dx / dist) * pull; b.vy -= (dy / dist) * pull;
                }
                ctx.moveTo(px, py);
                ctx.quadraticCurveTo((px + currX)/2, (py + currY)/2 + Math.sin(time*0.002+i)*5, currX, currY);
                if (!b.isDragged) {
                    const cdx = currX - cx, cdy = currY - cy, cdist = Math.sqrt(cdx*cdx + cdy*cdy) || 1;
                    b.vx += (-cdy/cdist) * 0.0008; b.vx += (cx - currX) * 0.00003;
                    bubbles.forEach((b2, j) => {
                        if(i === j) return;
                        const pdx = (b2.x+60) - currX, pdy = (b2.y+60) - currY, pdist = Math.hypot(pdx, pdy) || 1;
                        if(pdist < 135) {
                            const p = (135 - pdist) * 0.02;
                            b.vx -= (pdx/pdist)*p; b.vy -= (pdy/pdist)*p;
                        }
                    });
                    if(cdist < 100) {
                        const p = (100 - cdist) * 0.05;
                        b.vx += (cdx/cdist)*p; b.vy += (cdy/cdist)*p;
                    }
                    b.vx *= 0.92; b.vy *= 0.92; b.x += b.vx; b.y += b.vy;
                }
                b.x = Math.max(0, Math.min(ww - 120, b.x));
                b.y = Math.max(0, Math.min(wh - 120, b.y));
                b.el.style.transform = `translate3d(${b.x}px, ${b.y}px, 0)`;
            });
            ctx.stroke();
            requestAnimationFrame(animate);
        }

        function initPhysics() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; animate(0); }
        window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    </script>
</body>
</html>
