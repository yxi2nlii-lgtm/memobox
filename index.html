<script>
    // --- Firebase 配置 ---
    const firebaseConfig = {
        apiKey: "AIzaSyC7OLP-hG6ekdLQewLrB9BFGQCuzRlbnTE",
        authDomain: "memo-6a74a.firebaseapp.com",
        projectId: "memo-6a74a",
        storageBucket: "memo-6a74a.firebasestorage.app",
        messagingSenderId: "487014379920",
        appId: "1:487014379920:web:aa34c9662846c0a3d60315",
        databaseURL: "https://memo-6a74a-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const configRef = db.ref('object_config');
    const msgRef = db.ref('flow_messages');

    const stage = document.getElementById('stage');
    const canvas = document.getElementById('lineCanvas');
    const ctx = canvas.getContext('2d');
    let bubbles = [];
    let draggedBubble = null;
    const pageStartTime = Date.now();

    function resizeCanvas() {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr;
        canvas.height = window.innerHeight * dpr;
        ctx.scale(dpr, dpr);
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
    }

    configRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            injectData(data);
            document.body.classList.add('ready');
            if (bubbles.length === 0) { initPhysics(); }
        }
    });

    msgRef.limitToLast(15).on('child_added', (snapshot) => {
        const data = snapshot.val();
        if (data.type === 'clear_all') {
            if (data.time && data.time > pageStartTime) location.reload();
            return;
        }
        document.body.classList.remove('state-hero');
        if (data.mode === 'img') {
            createCustomPhotoBubble(data.img, data.text || "");
        } else {
            createBubbleElement({ type: 'text', content: data.text }, data.type === 'urgent');
        }
    });

    function createBubbleElement(data, isStatus) {
        const el = document.createElement('div');
        el.className = `bubble is-${data.type} ${isStatus ? 'is-status' : ''}`;
        el.innerHTML = `<div class="unread-dot"></div>${data.content}`;
        stage.appendChild(el);
        bubbles.push(setupBubbleObject(el, data, isStatus));
        requestAnimationFrame(() => el.classList.add('spawned'));
    }

    function createCustomPhotoBubble(imgSrc, caption) {
        const el = document.createElement('div');
        el.className = `bubble is-img`;
        el.innerHTML = `<div class="unread-dot"></div><img src="${imgSrc}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
        stage.appendChild(el);
        bubbles.push(setupBubbleObject(el, { type: 'img', content: caption, rawImg: imgSrc }, false));
        requestAnimationFrame(() => el.classList.add('spawned'));
    }

    function setupBubbleObject(el, data, isStatus) {
        const ww = window.innerWidth, wh = window.innerHeight;
        const initialX = ww/2 + (Math.random()-0.5)*200 - 60;
        const initialY = wh/2 + (Math.random()-0.5)*200 - 60;
        const bObj = { el, x: initialX, y: initialY, vx: 0, vy: 0, isDragged: false, data, isStatus };
        
        let startX, startY, startTime;
        const startAction = (e) => { 
            startTime = Date.now(); 
            const touch = e.touches ? e.touches[0] : e; 
            startX = touch.clientX; startY = touch.clientY; 
            draggedBubble = bObj; bObj.isDragged = true; 
        };
        const endAction = (e) => { 
            if(!bObj.isDragged) return; 
            const duration = Date.now() - startTime; 
            const touch = e.changedTouches ? e.changedTouches[0] : e; 
            const dist = Math.hypot(touch.clientX - startX, touch.clientY - startY); 
            if (duration < 250 && dist < 10) { 
                const dot = el.querySelector('.unread-dot'); 
                if(dot) dot.style.display = 'none'; 
                openModal(bObj); 
            } 
            bObj.isDragged = false; draggedBubble = null; 
        };
        el.addEventListener('mousedown', startAction);
        el.addEventListener('touchstart', startAction, {passive: false});
        window.addEventListener('mouseup', endAction);
        window.addEventListener('touchend', endAction);
        return bObj;
    }

    // --- 修复坐标的 animate 函数 ---
    function animate(time) {
        // 使用实际渲染宽度清空，确保全屏覆盖
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const ww = window.innerWidth;
        const wh = window.innerHeight;
        const cx = ww / 2;
        const cy = wh / 2;

        ctx.beginPath();
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
        ctx.lineWidth = 1.5;
        
        bubbles.forEach((b, i) => {
            // 当前泡泡圆心坐标
            const currX = b.x + 60;
            const currY = b.y + 60;

            let prevX, prevY;
            if (i === 0) {
                // 连向中心点圆心
                prevX = cx; 
                prevY = cy; 
            } else {
                // 连向上一个泡泡圆心
                prevX = bubbles[i-1].x + 60;
                prevY = bubbles[i-1].y + 60;
            }

            // 绘制线条坐标
            ctx.moveTo(prevX, prevY);
            ctx.quadraticCurveTo((prevX + currX)/2, (prevY + currY)/2 + Math.sin(time*0.002+i)*10, currX, currY);
            
            if (!b.isDragged) {
                const cdx = currX - cx, cdy = currY - cy, cdist = Math.sqrt(cdx*cdx + cdy*cdy) || 1;
                b.vx += (-cdy/cdist) * 0.0008; 
                b.vx += (cx - currX) * 0.00003;
                bubbles.forEach((b2, j) => {
                    if(i === j) return;
                    const pdx = (b2.x+60) - currX, pdy = (b2.y+60) - currY, pdist = Math.hypot(pdx, pdy) || 1;
                    if(pdist < 135) {
                        const p = (135 - pdist) * 0.02;
                        b.vx -= (pdx/pdist)*p; b.vy -= (pdy/pdist)*p;
                    }
                });
                if(cdist < 100) {
                    const p = (100 - cdist) * 0.05;
                    b.vx += (cdx/cdist)*p; b.vy += (cdy/cdist)*p;
                }
                b.vx *= 0.92; b.vy *= 0.92; b.x += b.vx; b.y += b.vy;
            }
            b.x = Math.max(0, Math.min(ww - 120, b.x));
            b.y = Math.max(0, Math.min(wh - 120, b.y));
            b.el.style.transform = `translate3d(${b.x}px, ${b.y}px, 0)`;
        });
        ctx.stroke();
        requestAnimationFrame(animate);
    }

    window.addEventListener('mousemove', (e) => { 
        if (draggedBubble) { 
            draggedBubble.x = e.clientX - 60; 
            draggedBubble.y = e.clientY - 60; 
        } 
    });
    window.addEventListener('touchmove', (e) => { 
        if (draggedBubble) { 
            const touch = e.touches[0];
            draggedBubble.x = touch.clientX - 60; 
            draggedBubble.y = touch.clientY - 60; 
            e.preventDefault(); 
        } 
    }, {passive: false});

    function injectData(data) {
        document.getElementById('display-name').innerText = data.name;
        document.getElementById('display-desc').innerText = data.desc;
        document.getElementById('display-date').innerText = data.dateStr;
        document.getElementById('display-avatar').src = data.imgData;
        document.querySelector('.bg-glass').style.backgroundImage = `url(${data.imgData})`;
    }

    function applyCustomization() {
        const fileInput = document.getElementById('upload-img');
        const name = document.getElementById('input-name').value;
        const desc = document.getElementById('input-desc').value;
        if (!fileInput.files[0] || !name) { alert("Please select an image and name."); return; }
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvasImg = document.createElement('canvas');
                const MAX_W = 600;
                let w = img.width, h = img.height;
                if (w > MAX_W) { h *= MAX_W / w; w = MAX_W; }
                canvasImg.width = w; canvasImg.height = h;
                canvasImg.getContext('2d').drawImage(img, 0, 0, w, h);
                configRef.set({
                    imgData: canvasImg.toDataURL('image/jpeg', 0.6),
                    name: name,
                    desc: desc || "A shared object.",
                    dateStr: new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).toUpperCase()
                });
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(fileInput.files[0]);
    }

    function handleHardReset() { if(confirm("Reset all data?")) { configRef.remove(); msgRef.push({ type: 'clear_all', time: Date.now() }); location.reload(); } }
    
    function initPhysics() { 
        resizeCanvas(); 
        animate(0); 
    }

    function triggerTopNotif(txt) {
        const nt = document.getElementById('top-notif');
        document.getElementById('notif-text').innerText = txt;
        nt.classList.add('active');
        setTimeout(() => nt.classList.remove('active'), 3000);
    }

    function openModal(b) {
        const visual = document.getElementById('m-visual');
        if (b.data.type === 'img' && b.data.rawImg) { visual.innerHTML = `<img src="${b.data.rawImg}" style="width:100%; border-radius:15px; margin-bottom:15px;">`; } 
        else { visual.innerHTML = ""; }
        document.getElementById('m-text').innerText = b.data.content || "";
        document.getElementById('comment-list').innerHTML = "";
        const modal = document.getElementById('modal-overlay');
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeModal() {
        const modal = document.getElementById('modal-overlay');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 400);
    }

    function toggleLike() { document.getElementById('btn-like').classList.toggle('liked'); }
    function toggleCommentBox() { const area = document.getElementById('comment-area'); area.style.display = area.style.display === 'none' ? 'block' : 'none'; }
    function postComment() { 
        const input = document.getElementById('comment-input'); 
        const list = document.getElementById('comment-list'); 
        if(input.value.trim()) { 
            const item = document.createElement('div'); 
            item.style.fontSize="12px"; item.style.color="#666"; item.style.marginTop="5px"; 
            item.innerText = input.value; list.appendChild(item); input.value = ""; 
        } 
    }

    window.onresize = resizeCanvas;
</script>
