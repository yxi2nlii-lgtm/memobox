<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BAMBOO FLOW - RECEIVER</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <style>
        /* 保持你原始 Code 1 的所有 CSS 样式不变 */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }
        body { background: #1a1a1a; font-family: 'Poppins', sans-serif; overflow: hidden; height: 100vh; width: 100vw; }
        .bg-glass { position: fixed; inset: 0; z-index: -1; background: #222; background-size: cover; background-position: center; filter: blur(60px) brightness(0.4); transform: scale(1.2); }
        .center-hub { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 4000; }
        .main-avatar { width: 280px; height: 280px; border-radius: 50%; overflow: hidden; transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1); border: 2px solid rgba(255,255,255,0.1); }
        body.is-active .main-avatar { width: 76px; height: 76px; }
        .main-avatar img { width: 100%; height: 100%; object-fit: cover; }
        #stage { position: absolute; inset: 0; z-index: 2500; pointer-events: none; }
        #lineCanvas { position: fixed; inset: 0; z-index: 50; pointer-events: none; }
        .bubble { position: absolute; border-radius: 50%; width: 120px; height: 120px; background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.5s; }
        .bubble.spawned { opacity: 1; }
        .bubble.is-status { background: #fff; color: #000; font-weight: 700; font-size: 10px; text-transform: uppercase; border: none; }
        .bubble.is-text { padding: 15px; color: #fff; font-size: 11px; text-align: center; }
    </style>
</head>
<body>

    <div class="bg-glass" id="bg-img"></div>
    <canvas id="lineCanvas"></canvas>
    <div class="center-hub">
        <div class="main-avatar"><img id="display-avatar" src=""></div>
    </div>
    <div id="stage"></div>

    <script>
        // --- 1. 注入你的 Firebase 配置 ---
        const firebaseConfig = {
            apiKey: "AIzaSyC7OLP-hG6ekdLQewLrB9BFGQCuzRlbnTE",
            authDomain: "memo-6a74a.firebaseapp.com",
            projectId: "memo-6a74a",
            storageBucket: "memo-6a74a.firebasestorage.app",
            messagingSenderId: "487014379920",
            appId: "1:487014379920:web:aa34c9662846c0a3d60315",
            databaseURL: "https://memo-6a74a-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('flow_messages');

        const stage = document.getElementById('stage');
        const canvas = document.getElementById('lineCanvas');
        const ctx = canvas.getContext('2d');
        let bubbles = [];

        // --- 2. 关键：监听云端数据 ---
        db.on('child_added', (snapshot) => {
            const data = snapshot.val();
            
            // 处理重置信号
            if (data.clear_all_signal || data.type === 'clear_all') {
                bubbles.forEach(b => b.el.remove());
                bubbles = [];
                document.body.classList.remove('is-active');
                return;
            }

            // 激活状态（缩回头像）
            document.body.classList.add('is-active');

            // 创建泡泡
            if (data.mode === 'img') {
                createImgBubble(data.img);
            } else {
                createTextBubble(data.text, data.type === 'urgent');
            }
        });

        // --- 物理逻辑 (保持不变) ---
        function createTextBubble(txt, isStatus) {
            const el = document.createElement('div');
            el.className = `bubble is-text ${isStatus ? 'is-status' : ''}`;
            el.innerText = txt;
            stage.appendChild(el);
            addBubbleToPhysics(el);
        }

        function createImgBubble(src) {
            const el = document.createElement('div');
            el.className = 'bubble is-img';
            el.innerHTML = `<img src="${src}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
            stage.appendChild(el);
            addBubbleToPhysics(el);
        }

        function addBubbleToPhysics(el) {
            const ww = window.innerWidth, wh = window.innerHeight;
            const bObj = { el, x: ww/2-60, y: wh/2-60, vx: (Math.random()-0.5)*2, vy: (Math.random()-0.5)*2 };
            bubbles.push(bObj);
            setTimeout(() => el.classList.add('spawned'), 50);
        }

        function animate() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const cx = window.innerWidth/2, cy = window.innerHeight/2;

            ctx.beginPath();
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            bubbles.forEach((b, i) => {
                let px = cx, py = cy;
                if (i > 0) { px = bubbles[i-1].x+60; py = bubbles[i-1].y+60; }
                const currX = b.x+60, currY = b.y+60;
                ctx.moveTo(px, py);
                ctx.lineTo(currX, currY);
                
                b.x += b.vx; b.y += b.vy; // 简单的漂浮效果
                b.el.style.transform = `translate3d(${b.x}px, ${b.y}px, 0)`;
            });
            ctx.stroke();
            requestAnimationFrame(animate);
        }
        animate();

        // 初始背景加载
        const saved = localStorage.getItem('userObjectData');
        if (saved) {
            const d = JSON.parse(saved);
            document.getElementById('display-avatar').src = d.imgData;
            document.getElementById('bg-img').style.backgroundImage = `url(${d.imgData})`;
        }
    </script>
</body>
</html>
