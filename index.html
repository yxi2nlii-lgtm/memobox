<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BAMBOO FLOW - FIX CENTERED LINE</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <style>
        /* 样式保持不变 */
        #setup-layer { position: fixed; inset: 0; z-index: 10000; background: #1a1a1a; display: flex; align-items: center; justify-content: center; transition: opacity 0.8s ease, transform 0.8s ease; }
        .setup-card { width: 85%; max-width: 400px; color: white; text-align: left; background: rgba(255,255,255,0.05); padding: 30px; border-radius: 30px; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .setup-card h2 { font-size: 22px; margin-bottom: 20px; font-weight: 600; font-family: 'Poppins'; }
        .input-box { margin-bottom: 20px; }
        .input-box label { display: block; font-size: 12px; opacity: 0.6; margin-bottom: 8px; text-transform: uppercase; }
        .input-box input, .input-box textarea { width: 100%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 12px; color: white; font-family: inherit; outline: none; }
        .generate-btn { width: 100%; padding: 15px; border-radius: 15px; border: none; background: #ffffff; color: #000; font-weight: 600; cursor: pointer; }
        body.ready #setup-layer { opacity: 0; pointer-events: none; transform: translateY(-20px); }
        #reset-trigger { position: fixed; top: 20px; right: 20px; z-index: 5000; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; font-size: 10px; cursor: pointer; opacity: 0.3; }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }
        body { background: #1a1a1a; font-family: 'Poppins', sans-serif; overflow: hidden; height: 100vh; width: 100vw; touch-action: none; }
        body.state-hero #stage, body.state-hero #lineCanvas { opacity: 0; pointer-events: none; }
        .center-hub { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 4000; pointer-events: none; }
        .main-avatar { width: 76px; height: 76px; border-radius: 50%; background: rgba(255,255,255,0.1); overflow: hidden; transition: all 1s cubic-bezier(0.19, 1, 0.22, 1); cursor: pointer; pointer-events: auto; z-index: 4001; box-shadow: none; flex-shrink: 0; transform: translateY(0); }
        body.state-hero .main-avatar { width: 280px; height: 280px; box-shadow: 0 30px 80px rgba(0,0,0,0.6); transform: translateY(-60px); }
        .hero-text-block { position: absolute; top: 50%; left: 0; width: 100%; padding-top: 100px; text-align: center; color: white; transition: all 0.7s ease; pointer-events: none; opacity: 0; transform: translateY(20px); }
        body.state-hero .hero-text-block { opacity: 1; transform: translateY(0); }
        .hero-text-block h1 { font-size: 26px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; line-height: 1; margin-bottom: 10px; }
        .hero-text-block .time { font-size: 13px; opacity: 0.5; letter-spacing: 1px; margin-bottom: 25px; }
        .hero-text-block .description { font-size: 14px; font-weight: 300; line-height: 1.6; max-width: 400px; margin: 0 auto; opacity: 0.8; }
        #stage, #lineCanvas { transition: opacity 1.2s ease; }
        .bg-glass { position: fixed; inset: 0; z-index: -1; background: #222; background-position: center; background-size: cover; transform: scale(1.8); filter: blur(60px) brightness(0.4); }
        #lineCanvas { position: fixed; inset: 0; z-index: 50; pointer-events: none; width: 100vw; height: 100vh; }
        #top-notif { position: fixed; top: -80px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 350px; background: rgba(255,255,255,0.95); padding: 12px 20px; border-radius: 40px; z-index: 5000; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; }
        #top-notif.active { transform: translateX(-50%) translateY(100px); }
        .main-avatar img { width: 100%; height: 100%; object-fit: cover; }
        #stage { position: absolute; inset: 0; z-index: 2500; pointer-events: none; }
        .bubble { position: absolute; border-radius: 50%; width: 120px; height: 120px; background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); cursor: grab; pointer-events: auto; opacity: 0; display: flex; align-items: center; justify-content: center; will-change: transform, opacity; z-index: 3000; top: 0; left: 0; }
        .bubble > * { pointer-events: none; }
        .bubble.spawned { opacity: 1; transition: opacity 1s ease-out; }
        .bubble.is-status { background: #ffffff; border: none; color: #000; font-weight: 600; }
        .bubble.is-text { padding: 18px; font-size: 11px; color: rgba(255,255,255,0.8); text-align: center; line-height: 1.4; }
        .unread-dot { position: absolute; top: 18px; right: 18px; width: 8px; height: 8px; background: #ff3b30; border-radius: 50%; }
        #modal-overlay { position: fixed; inset: 0; z-index: 6000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); background: rgba(0,0,0,0.3); opacity: 0; transition: 0.4s; }
        #modal-overlay.active { display: flex; opacity: 1; }
        .modal-card { background: white; padding: 30px; border-radius: 30px; width: 85%; max-width: 320px; text-align: center; position: relative; }
    </style>
</head>
<body class="state-hero">

    <div id="setup-layer">
        <div class="setup-card">
            <h2>Initialize Object</h2>
            <div class="input-box"><label>Main Image</label><input type="file" id="upload-img" accept="image/*"></div>
            <div class="input-box"><label>Name</label><input type="text" id="input-name" placeholder="e.g. My Lucky Bamboo"></div>
            <div class="input-box"><label>Description</label><textarea id="input-desc" rows="3" placeholder="Tell the story..."></textarea></div>
            <button class="generate-btn" onclick="applyCustomization()">Save to Cloud</button>
        </div>
    </div>

    <button id="reset-trigger" onclick="handleHardReset()">RESET ALL</button>
    <div id="top-notif"><div style="width: 8px; height: 8px; background: #ff3b30; border-radius: 50%;"></div><span id="notif-text" style="font-size: 12px; color: #333;"></span></div>
    <div class="bg-glass"></div>
    <canvas id="lineCanvas"></canvas>

    <div id="modal-overlay" onclick="closeModal()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div id="m-visual"></div>
            <p id="m-text" style="color: #333; font-size: 14px; line-height: 1.5; margin-bottom: 10px;"></p>
            <div class="modal-actions" style="display:flex; justify-content:center; gap:20px;">
                 <button class="btn-icon" onclick="toggleLike()">Like</button>
                 <button class="btn-icon" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="center-hub">
        <div class="main-avatar" onclick="document.body.classList.toggle('state-hero')"><img id="display-avatar" src=""></div>
        <div class="hero-text-block">
            <h1 id="display-name">LOADING...</h1>
            <p class="time" id="display-date"></p>
            <p class="description" id="display-desc"></p>
        </div>
    </div>
    <div id="stage"></div>

    <script>
        // --- Firebase 配置 (保持你的配置) ---
        const firebaseConfig = {
            apiKey: "AIzaSyC7OLP-hG6ekdLQewLrB9BFGQCuzRlbnTE",
            authDomain: "memo-6a74a.firebaseapp.com",
            projectId: "memo-6a74a",
            storageBucket: "memo-6a74a.firebasestorage.app",
            messagingSenderId: "487014379920",
            appId: "1:487014379920:web:aa34c9662846c0a3d60315",
            databaseURL: "https://memo-6a74a-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const configRef = db.ref('object_config');
        const msgRef = db.ref('flow_messages');

        const stage = document.getElementById('stage');
        const canvas = document.getElementById('lineCanvas');
        const ctx = canvas.getContext('2d');
        let bubbles = [];
        let draggedBubble = null;
        const pageStartTime = Date.now();

        // --- 核心修复 1: 适配高分辨率屏幕的 Canvas ---
        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            ctx.scale(dpr, dpr);
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
        }

        window.onresize = resizeCanvas;
        resizeCanvas();

        // Firebase 监听逻辑保持不变
        configRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                injectData(data);
                document.body.classList.add('ready');
                if (bubbles.length === 0) { animate(0); }
            }
        });

        msgRef.limitToLast(15).on('child_added', (snapshot) => {
            const data = snapshot.val();
            if (data.type === 'clear_all') {
                if (data.time && data.time > pageStartTime) location.reload();
                return;
            }
            document.body.classList.remove('state-hero');
            if (data.mode === 'img') {
                createCustomPhotoBubble(data.img, data.text || "");
            } else {
                createBubbleElement({ type: 'text', content: data.text }, data.type === 'urgent');
            }
        });

        function createBubbleElement(data, isStatus) {
            const el = document.createElement('div');
            el.className = `bubble is-${data.type} ${isStatus ? 'is-status' : ''}`;
            el.innerHTML = `<div class="unread-dot"></div>${data.content}`;
            stage.appendChild(el);
            bubbles.push(setupBubbleObject(el, data, isStatus));
            requestAnimationFrame(() => el.classList.add('spawned'));
        }

        function createCustomPhotoBubble(imgSrc, caption) {
            const el = document.createElement('div');
            el.className = `bubble is-img`;
            el.innerHTML = `<div class="unread-dot"></div><img src="${imgSrc}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
            stage.appendChild(el);
            bubbles.push(setupBubbleObject(el, { type: 'img', content: caption, rawImg: imgSrc }, false));
            requestAnimationFrame(() => el.classList.add('spawned'));
        }

        function setupBubbleObject(el, data, isStatus) {
            const ww = window.innerWidth, wh = window.innerHeight;
            const initialX = ww/2 + (Math.random()-0.5)*150 - 60;
            const initialY = wh/2 + (Math.random()-0.5)*150 - 60;
            const bObj = { el, x: initialX, y: initialY, vx: 0, vy: 0, isDragged: false, data, isStatus };
            
            const startAction = (e) => { 
                const touch = e.touches ? e.touches[0] : e; 
                draggedBubble = bObj; 
                bObj.isDragged = true; 
            };
            const endAction = () => { 
                if(bObj.isDragged) openModal(bObj);
                bObj.isDragged = false; 
                draggedBubble = null; 
            };

            el.addEventListener('mousedown', startAction);
            el.addEventListener('touchstart', startAction, {passive: false});
            return bObj;
        }

        // --- 核心修复 2: 修正坐标偏置 ---
        function animate(time) {
            ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
            const ww = window.innerWidth, wh = window.innerHeight;
            const cx = ww / 2;
            const cy = wh / 2; // 屏幕物理中心

            ctx.beginPath();
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 1.5;

            bubbles.forEach((b, i) => {
                // 连线锚点计算：泡泡左上角坐标 (x,y) + 半径 (60)
                const currX = b.x + 60;
                const currY = b.y + 60;

                // 确定上一个点的坐标（第一个泡泡连中心头像）
                let prevX = cx;
                let prevY = cy;
                if (i > 0) {
                    prevX = bubbles[i-1].x + 60;
                    prevY = bubbles[i-1].y + 60;
                }

                // 物理模拟逻辑保持不变
                if (!b.isDragged) {
                    const cdx = currX - cx, cdy = currY - cy, cdist = Math.sqrt(cdx*cdx + cdy*cdy) || 1;
                    b.vx += (-cdy/cdist) * 0.0008; 
                    b.vx += (cx - currX) * 0.00003;
                    
                    bubbles.forEach((b2, j) => {
                        if(i === j) return;
                        const pdx = (b2.x+60) - currX, pdy = (b2.y+60) - currY, pdist = Math.hypot(pdx, pdy) || 1;
                        if(pdist < 130) {
                            const p = (130 - pdist) * 0.02;
                            b.vx -= (pdx/pdist)*p; b.vy -= (pdy/pdist)*p;
                        }
                    });
                    
                    b.vx *= 0.92; b.vy *= 0.92; b.x += b.vx; b.y += b.vy;
                }

                // 绘制曲线：精确指向泡泡物理中心
                ctx.moveTo(prevX, prevY);
                ctx.quadraticCurveTo(
                    (prevX + currX)/2, 
                    (prevY + currY)/2 + Math.sin(time*0.002+i)*10, 
                    currX, 
                    currY
                );

                // 更新 DOM 位置
                b.x = Math.max(0, Math.min(ww - 120, b.x));
                b.y = Math.max(0, Math.min(wh - 120, b.y));
                b.el.style.transform = `translate3d(${b.x}px, ${b.y}px, 0)`;
            });

            ctx.stroke();
            requestAnimationFrame(animate);
        }

        // 全局交互监听
        window.addEventListener('mousemove', (e) => {
            if (draggedBubble) {
                draggedBubble.x = e.clientX - 60;
                draggedBubble.y = e.clientY - 60;
            }
        });
        window.addEventListener('touchmove', (e) => {
            if (draggedBubble) {
                draggedBubble.x = e.touches[0].clientX - 60;
                draggedBubble.y = e.touches[0].clientY - 60;
                e.preventDefault();
            }
        }, {passive: false});
        window.addEventListener('mouseup', () => { if(draggedBubble) draggedBubble.isDragged = false; draggedBubble = null; });
        window.addEventListener('touchend', () => { if(draggedBubble) draggedBubble.isDragged = false; draggedBubble = null; });

        function injectData(data) {
            document.getElementById('display-name').innerText = data.name;
            document.getElementById('display-desc').innerText = data.desc;
            document.getElementById('display-date').innerText = data.dateStr;
            document.getElementById('display-avatar').src = data.imgData;
            document.querySelector('.bg-glass').style.backgroundImage = `url(${data.imgData})`;
        }

        function applyCustomization() {
            const fileInput = document.getElementById('upload-img');
            const name = document.getElementById('input-name').value;
            const desc = document.getElementById('input-desc').value;
            if (!fileInput.files[0] || !name) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                configRef.set({
                    imgData: e.target.result,
                    name: name,
                    desc: desc,
                    dateStr: new Date().toLocaleDateString()
                });
            };
            reader.readAsDataURL(fileInput.files[0]);
        }

        function openModal(b) {
            const modal = document.getElementById('modal-overlay');
            document.getElementById('m-text').innerText = b.data.content;
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
            const dot = b.el.querySelector('.unread-dot');
            if(dot) dot.style.display = 'none';
        }

        function closeModal() {
            const modal = document.getElementById('modal-overlay');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 400);
        }

        function handleHardReset() { if(confirm("Reset?")) { configRef.remove(); msgRef.remove(); location.reload(); } }
    </script>
</body>
</html>
